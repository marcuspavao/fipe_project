name: Deploy to Server via Git Pull

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0 
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "--- ‚úÖ Conectado ao servidor. Iniciando deploy... ---"
            
            # 1. Navega para a pasta do projeto no servidor.
            # Garanta que esta pasta j√° exista e seja um reposit√≥rio git.
            cd projects/fipe_project            
            
            echo "--- üîÑ Atualizando c√≥digo com git pull... ---"
            # 2. Puxa as √∫ltimas altera√ß√µes da branch principal.
            git pull origin main
            
            echo "--- üê≥ Reconstruindo e reiniciando os containers Docker... ---"
            # 3. O comando correto: reconstr√≥i a imagem (se necess√°rio) e sobe os servi√ßos em background.
            docker compose up --build -d
            
            echo "--- üßπ Limpando imagens Docker antigas (opcional, mas recomendado)... ---"
            # 4. Remove imagens "dangling" (sem tag) para economizar espa√ßo em disco.
            docker image prune -f
            
            echo "--- üéâ Deploy finalizado com sucesso! ---"
