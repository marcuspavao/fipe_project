name: Deploy to Server via Git Pull

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0 
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "--- âœ… Conectado ao servidor. Iniciando deploy... ---"
            
            # 1. Navega para a pasta do projeto no servidor.
            # Garanta que esta pasta jÃ¡ exista e seja um repositÃ³rio git.
            cd ~/fipe_project
            
            echo "--- ğŸ”„ Atualizando cÃ³digo com git pull... ---"
            # 2. Puxa as Ãºltimas alteraÃ§Ãµes da branch principal.
            git pull origin main
            
            echo "--- ğŸ³ Reconstruindo e reiniciando os containers Docker... ---"
            # 3. O comando correto: reconstrÃ³i a imagem (se necessÃ¡rio) e sobe os serviÃ§os em background.
            docker compose up --build -d
            
            echo "--- ğŸ§¹ Limpando imagens Docker antigas (opcional, mas recomendado)... ---"
            # 4. Remove imagens "dangling" (sem tag) para economizar espaÃ§o em disco.
            docker image prune -f
            
            echo "--- ğŸ‰ Deploy finalizado com sucesso! ---"
